<script>
  const Views = {
    Login: "Login",
    Main: "Main",
    PackageSelection: "PackageSelection",
  };
  let currentView = Views.Login;

  let availablePackages = [];

  let log = "";

  console.log(availablePackages);
  console.log(typeof availablePackages);

  let selectedPackage = null;
	
	// The build parameters.
  let secretkey = null;
	let accesskey = null;
	let region = null;

  function processLogin() {
    logMessage("Entered main view from login screen");
    currentView = Views.Main;
  }

  function startNewEnvironment() {
    logMessage("Starting new environment");
    const path = "http://" + window.location.hostname + ":80/api/list";

    const response = fetch(path)
      .then((response) => response.json())
      .then((data) => {
        logMessage("Available package data fetched from backend");
        availablePackages = [];
        selectedPackage = null;
        availablePackages = Array.from(data.templates);
        currentView = Views.PackageSelection;
      })
      .catch((error) => {
        logMessage(error);
        availablePackages = [];
        selectedPackage = null;
        return [];
      });
  }

  function returnToMain() {
    logMessage("Returned to main view from package selection screen");
    availablePackages = [];
    selectedPackage = null;
    currentView = Views.Main;
		
	let secretkey = null;
	let accesskey = null;
	let region = null;
		
  }

  async function sendBuildRequest() {
    const path = "http://" + window.location.hostname + ":80/api/build";

    let buildParameters = {
        AWS_ACCESS_KEY_ID: accesskey,
        AWS_SECRET_ACCESS_KEY: secretkey, // We need to figure a secure way to handle this
        AWS_REGION: region
    };

    let buildOptions = {
      package: selectedPackage.name,
      parameters: buildParameters,
    };

    const res = await fetch(path, {
      method: "POST",
      body: JSON.stringify(buildOptions),
      headers: { "Content-Type": "application/json" },
    });

    logMessage("Sent build request to backend");
    if (res.status == 200) {
      const json = await res.json();
      let result = JSON.stringify(json);
      logMessage("Received response from backend: " + result);
      getBuildStatus();
    } else {
      logMessage("Backend reported status: " + res.status);
    }

    selectedPackage = null;
    currentView = Views.Main;
  }

  async function getBuildStatus(/*buildId*/) {
    const path = SERVER_CONNECTION + "://" + window.location.hostname + "/api/status";
    var notFinished = true;
    while(notFinished){
        const res = await fetch(path);
        if( res.status == 200 ){
            let state = res.body;
            logMessage( `Current build status: ${ state } `);
            if(state === 'completed'){
                notFinished = false;  // We got the last status.
                return;
            }
        }
    }
  }

  function logMessage(message) {
		var newMessage = new Date(Date.now()) + " - " + message + "\n";
		log = log + newMessage;
  }

  logMessage("Initialized frontend");
</script>

<h1>One AWS to go, Please!</h1>

{#if currentView == Views.Login}
  <button class="login-button" on:click={processLogin}> Login </button>
{/if}

<div class="grid-container">

  {#if currentView == Views.Main}
    <button class="start-button" on:click={startNewEnvironment}> Start new environment </button>
	
		<h2 class="log-header">Log</h2>
		<textarea readonly bind:value={log}></textarea>
  {/if}

  {#if currentView == Views.PackageSelection}
    <h2>Available packages</h2>

    <select single bind:value={selectedPackage}>
      {#each availablePackages as pkg}
        <option value={pkg}>
          {pkg.name}
        </option>
      {/each}
    </select>

    {#if selectedPackage}
      <h2>Selected package: {selectedPackage.name}</h2>
      {selectedPackage.description}

	<div>
		Access key id:
		<input bind:value={accesskey}/>
	</div>

	<div>
		Region:
		<input bind:value={region}/>
	</div>

	<div>
		Secret key:
		<input type=password bind:value={secretkey}/>
	</div>

	{#if accesskey && region && secretkey}
    	<button on:click={sendBuildRequest}> Build </button>
	{/if}

  {/if}

    <button on:click={returnToMain}> Return </button>
  {/if}

</div>

<style>
  :global(body) {
    background-color: #2b2b2b;
    color: #d6d6d6;
  }

  h1 {
  	text-align: center;
	}
	
	.login-button {
		display: block;
    margin-left: auto;
    margin-right: auto;
	}

  textarea {
		grid-column: 3;
    overflow-y: auto;
    height: 500px;
    resize: none;
		outline: 0px solid transparent !important;
	}
	
	.grid-container {
		display: grid;
		grid: 45% auto 45%;
		column-gap: 50px;
  	column-gap: 50px;
	}
	
	.log-header {
		grid-area: 1 / 3;
	}
	
	.start-button {
		grid-column: 1;
		margin: 20px;
	}
	
</style>